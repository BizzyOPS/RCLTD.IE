// Controller Bot - AI Chatbot for Robotics & Control Ltd
// Using OpenAI integration - referenced from blueprint:javascript_openai
// the newest OpenAI model is "gpt-5" which was released August 7, 2025. do not change this unless explicitly requested by the user

class ControllerBot {
    constructor() {
        this.isOpen = false;
        this.messages = [];
        this.isTyping = false;
        this.init();
    }

    init() {
        this.createChatInterface();
        this.bindEvents();
        this.addWelcomeMessage();
    }

    createChatInterface() {
        // Create chatbot HTML structure
        const chatbotHTML = `
            <!-- Chatbot Toggle Button -->
            <div id="chatbot-toggle" class="chatbot-toggle" title="Chat with Controller Bot">
                <img src="images/logo.png" alt="Controller Bot" class="chatbot-icon">
                <div class="chatbot-pulse"></div>
            </div>

            <!-- Chatbot Container -->
            <div id="chatbot-container" class="chatbot-container">
                <div class="chatbot-header">
                    <div class="chatbot-header-info">
                        <img src="images/logo.png" alt="Controller Bot" class="chatbot-avatar">
                        <div class="chatbot-header-text">
                            <h3>Controller Bot</h3>
                            <span class="chatbot-status">Online ‚Ä¢ Ready to help</span>
                        </div>
                    </div>
                    <button id="chatbot-close" class="chatbot-close" aria-label="Close chat">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
                        </svg>
                    </button>
                </div>
                
                <div class="chatbot-messages" id="chatbot-messages">
                    <!-- Messages will be added here dynamically -->
                </div>
                
                <div class="chatbot-input-container">
                    <div class="chatbot-input-wrapper">
                        <input 
                            type="text" 
                            id="chatbot-input" 
                            class="chatbot-input" 
                            placeholder="Ask me about services, training, or products..."
                            maxlength="500"
                        >
                        <button id="chatbot-send" class="chatbot-send-btn" aria-label="Send message">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M2,21L23,12L2,3V10L17,12L2,14V21Z"/>
                            </svg>
                        </button>
                    </div>
                    <div class="chatbot-quick-actions">
                        <button class="quick-action-btn" data-message="Tell me about automation services">
                            üîß Automation
                        </button>
                        <button class="quick-action-btn" data-message="What safety services do you provide?">
                            üõ°Ô∏è Safety
                        </button>
                        <button class="quick-action-btn" data-message="Tell me about electrical design">
                            ‚ö° Electrical Design
                        </button>
                        <button class="quick-action-btn" data-message="What about panel building?">
                            üèóÔ∏è Panel Building
                        </button>
                        <button class="quick-action-btn" data-message="Tell me about safety training">
                            üìö Training
                        </button>
                        <button class="quick-action-btn" data-message="How can I get a quote?">
                            üí¨ Get Quote
                        </button>
                    </div>
                </div>
            </div>
        `;

        // Add chatbot to the page
        document.body.insertAdjacentHTML('beforeend', chatbotHTML);
    }

    bindEvents() {
        const toggle = document.getElementById('chatbot-toggle');
        const close = document.getElementById('chatbot-close');
        const sendBtn = document.getElementById('chatbot-send');
        const input = document.getElementById('chatbot-input');
        const quickActions = document.querySelectorAll('.quick-action-btn');

        toggle.addEventListener('click', () => this.toggleChat());
        close.addEventListener('click', () => this.closeChat());
        sendBtn.addEventListener('click', () => this.sendMessage());
        
        input.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                this.sendMessage();
            }
        });

        // Quick action buttons
        quickActions.forEach(btn => {
            btn.addEventListener('click', () => {
                const message = btn.dataset.message;
                this.sendQuickMessage(message);
            });
        });

        // Close on escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && this.isOpen) {
                this.closeChat();
            }
        });
    }

    toggleChat() {
        if (this.isOpen) {
            this.closeChat();
        } else {
            this.openChat();
        }
    }

    openChat() {
        const container = document.getElementById('chatbot-container');
        const toggle = document.getElementById('chatbot-toggle');
        
        container.classList.add('open');
        toggle.classList.add('hidden');
        this.isOpen = true;

        // Focus input after animation
        setTimeout(() => {
            document.getElementById('chatbot-input').focus();
        }, 300);
    }

    closeChat() {
        const container = document.getElementById('chatbot-container');
        const toggle = document.getElementById('chatbot-toggle');
        
        container.classList.remove('open');
        toggle.classList.remove('hidden');
        this.isOpen = false;
    }

    addWelcomeMessage() {
        const welcomeMessage = {
            type: 'bot',
            content: `Hello! I'm Controller Bot ü§ñ, your virtual assistant from Robotics & Control Ltd. 

I'm here to help you with:
‚Ä¢ **Automation Solutions** - Industrial control systems
‚Ä¢ **Safety Services** - Machine safety and compliance  
‚Ä¢ **Electrical Design** - Professional engineering
‚Ä¢ **Panel Building** - Custom control panels
‚Ä¢ **Safety Training** - Interactive courses and certification

How can I assist you today?`,
            timestamp: new Date()
        };
        
        this.messages.push(welcomeMessage);
        this.renderMessage(welcomeMessage);
    }

    async sendMessage() {
        const input = document.getElementById('chatbot-input');
        const message = input.value.trim();
        
        if (!message || this.isTyping) return;

        // Add user message
        const userMessage = {
            type: 'user',
            content: message,
            timestamp: new Date()
        };
        
        this.messages.push(userMessage);
        this.renderMessage(userMessage);
        input.value = '';

        // Get bot response
        await this.getBotResponse(message);
    }

    sendQuickMessage(message) {
        const input = document.getElementById('chatbot-input');
        input.value = message;
        this.sendMessage();
    }

    async getBotResponse(userMessage) {
        this.showTypingIndicator();

        try {
            // For now, use local knowledge base - in production, this would call OpenAI API
            const response = await this.getLocalResponse(userMessage);
            
            const botMessage = {
                type: 'bot',
                content: response,
                timestamp: new Date()
            };
            
            this.messages.push(botMessage);
            this.hideTypingIndicator();
            this.renderMessage(botMessage);
            
        } catch (error) {
            this.hideTypingIndicator();
            
            const errorMessage = {
                type: 'bot',
                content: "I apologize, but I'm experiencing technical difficulties. Please contact us directly at +353 (0) 52 7443258 or info@rcltd.ie for immediate assistance.",
                timestamp: new Date()
            };
            
            this.messages.push(errorMessage);
            this.renderMessage(errorMessage);
        }
    }

    // Local knowledge base - replace with OpenAI API calls in production
    async getLocalResponse(message) {
        const lowerMessage = message.toLowerCase();
        
        // Simulate API delay
        await new Promise(resolve => setTimeout(resolve, 1000 + Math.random() * 1000));

        // Automation services
        if (lowerMessage.includes('automation') && (lowerMessage.includes('service') || lowerMessage.includes('tell me about') || lowerMessage.includes('what'))) {
            return `**üîß Industrial Automation Services - Robotics & Control Ltd**

We specialize in advanced automation solutions across **pharmaceutical, industrial, automotive, and food & beverage** sectors:

**üè≠ Our Automation Expertise:**
‚Ä¢ **PLC Programming & Integration** - Siemens, Allen-Bradley, Schneider Electric
‚Ä¢ **SCADA Systems** - Ignition, WinCC, FactoryTalk View
‚Ä¢ **Industrial Networking** - Profinet, EtherNet/IP, Modbus TCP
‚Ä¢ **Process Control** - Temperature, pressure, flow control systems
‚Ä¢ **Robotics Integration** - Industrial & collaborative robots
‚Ä¢ **Vision Systems** - Quality control and inspection automation

**üíº Recent Projects:**
‚Ä¢ Pharmaceutical packaging line automation
‚Ä¢ Automotive assembly line control systems
‚Ä¢ Food processing SCADA implementation

**üîó Learn More:**
[View Automation Services ‚Üí](automation.html)
[Get Free Consultation ‚Üí](contact.html)

Which industry are you in? I can provide more specific examples for your sector!`;
        }

        // Safety services
        if (lowerMessage.includes('safety') && (lowerMessage.includes('service') || lowerMessage.includes('what') || lowerMessage.includes('provide'))) {
            return `**üõ°Ô∏è Machine Safety Services - Keeping Your Operations Compliant**

R&C Ltd provides comprehensive safety solutions to protect your workforce and ensure regulatory compliance:

**üîç Safety Assessment & Design:**
‚Ä¢ **Risk Assessment** - ISO 12100, ISO 13849 compliance
‚Ä¢ **Safety System Design** - Safety PLCs, light curtains, emergency stops
‚Ä¢ **Machine Safeguarding** - Guards, interlocks, two-hand controls
‚Ä¢ **Functional Safety** - SIL rating and validation
‚Ä¢ **Robot Safety** - Collaborative and industrial robot safety systems

**üìã Compliance Services:**
‚Ä¢ **CE Marking** - Machinery Directive 2006/42/EC
‚Ä¢ **Safety Audits** - Existing machine assessments
‚Ä¢ **Documentation** - Safety manuals, risk assessments
‚Ä¢ **Training** - Safety awareness for operators and engineers

**‚úÖ Industries We Serve:**
‚Ä¢ Pharmaceutical (GMP compliance)
‚Ä¢ Automotive (safety-critical systems)
‚Ä¢ Food & Beverage (hygiene + safety)

**üîó Take Action:**
[Safety Services Details ‚Üí](safety.html)
[Request Safety Audit ‚Üí](contact.html)

Do you have specific safety challenges or compliance requirements?`;
        }

        // Electrical design
        if (lowerMessage.includes('electrical') && (lowerMessage.includes('design') || lowerMessage.includes('tell me') || lowerMessage.includes('about'))) {
            return `**‚ö° Professional Electrical Design Services**

Our experienced engineers deliver robust electrical solutions using industry-leading design tools:

**üéØ Design Capabilities:**
‚Ä¢ **Control System Design** - Motor control, power distribution
‚Ä¢ **Schematic Design** - E3.Series, AutoCAD Electrical
‚Ä¢ **Power Systems** - Load calculations, cable sizing
‚Ä¢ **Motor Control Centers** - Custom MCC design and specifications
‚Ä¢ **Instrumentation Design** - Field devices, control loops
‚Ä¢ **Hazardous Area Design** - ATEX/IECEx classifications

**üìê Design Standards:**
‚Ä¢ **IEC 60204-1** - Electrical equipment of machines
‚Ä¢ **IEC 61439** - Low-voltage switchgear assemblies
‚Ä¢ **IEC 60364** - Electrical installations of buildings
‚Ä¢ **EN 60204** - Safety of machinery electrical equipment

**üèÜ Our Track Record:**
‚Ä¢ 15+ years of design experience
‚Ä¢ 200+ successful projects delivered
‚Ä¢ Full compliance with Irish and EU regulations

**üîó Get Started:**
[Electrical Design Portfolio ‚Üí](design.html)
[Request Design Quote ‚Üí](contact.html)

What type of electrical system are you planning?`;
        }

        // Panel building
        if (lowerMessage.includes('panel') && (lowerMessage.includes('building') || lowerMessage.includes('about') || lowerMessage.includes('what'))) {
            return `**üèóÔ∏è Custom Panel Building & Manufacturing**

From design to delivery, we build professional control panels to the highest standards:

**üîß Panel Building Services:**
‚Ä¢ **Custom Control Panels** - Motor control, process control
‚Ä¢ **MCC Manufacturing** - Motor Control Centers to IEC 61439
‚Ä¢ **Switchgear Assembly** - Low voltage distribution panels
‚Ä¢ **Instrumentation Panels** - Field junction boxes, marshalling
‚Ä¢ **Retrofit & Upgrades** - Modernizing existing panels
‚Ä¢ **Testing & Commissioning** - Full FAT and SAT procedures

**üè≠ Manufacturing Standards:**
‚Ä¢ **IEC 61439** - Switchgear and controlgear assemblies
‚Ä¢ **CE Marking** - Full compliance and documentation
‚Ä¢ **Quality Control** - Rigorous testing at every stage
‚Ä¢ **Documentation** - Complete as-built drawings and manuals

**üì¶ What We Deliver:**
‚Ä¢ Professional wiring and labeling
‚Ä¢ Comprehensive testing reports
‚Ä¢ Installation and commissioning support
‚Ä¢ 12-month warranty on all work

**üîó Next Steps:**
[Panel Building Gallery ‚Üí](panel.html)
[Request Panel Quote ‚Üí](contact.html)

What size and type of panel do you need?`;
        }

        // General services overview
        if (lowerMessage.includes('service') || lowerMessage.includes('what do you do')) {
            return `**üè¢ Robotics & Control Ltd - Your Automation Partner Since 2010**

We provide comprehensive industrial solutions across Ireland and internationally:

**üîß Core Services:**
‚Ä¢ **[Automation Services](automation.html)** - PLC, SCADA, robotics integration
‚Ä¢ **[Safety Solutions](safety.html)** - Risk assessment, compliance, CE marking
‚Ä¢ **[Electrical Design](design.html)** - Control systems, power distribution
‚Ä¢ **[Panel Building](panel.html)** - Custom control panels, MCCs
‚Ä¢ **[Safety Training](safety-training.html)** - Interactive courses, certification

**üè≠ Industries We Serve:**
‚Ä¢ **Pharmaceutical** - GMP compliance, validation protocols
‚Ä¢ **Automotive** - Assembly lines, quality control systems
‚Ä¢ **Food & Beverage** - Process control, hygiene standards
‚Ä¢ **General Industry** - Manufacturing automation solutions

**üìû Ready to Start?**
[View All Services ‚Üí](services.html)
[Get Free Quote ‚Üí](contact.html)
[Call Now: +353 (0) 52 7443258](tel:+353527443258)

Which service interests you most?`;
        }

        // Training responses
        if (lowerMessage.includes('training') || lowerMessage.includes('course') || lowerMessage.includes('learn')) {
            return `**üìö Professional Safety Training Programs**

R&C Ltd offers comprehensive safety training to keep your team compliant and safe:

**üéì Available Training Modules:**
‚Ä¢ **Automation Safety** - Industrial robot safety, cobot integration (4-5 hrs)
‚Ä¢ **Electrical Design Safety** - IEC 60204-1, protective systems (4-5 hrs)  
‚Ä¢ **Panel Building Safety** - IEC 61439, testing procedures (4-5 hrs)
‚Ä¢ **Risk Assessment** - ISO 12100 methodology and practice
‚Ä¢ **Machine Safety** - Guards, interlocks, emergency systems

**üí° Training Features:**
‚Ä¢ **Interactive Online Platform** - Learn at your own pace
‚Ä¢ **Real Industry Scenarios** - Practical examples from our projects
‚Ä¢ **Progress Tracking** - Monitor your team's development
‚Ä¢ **90% Pass Requirement** - Ensures thorough understanding
‚Ä¢ **Industry Recognition** - Certificates valued by employers

**üèÜ Why Choose Our Training:**
‚Ä¢ Developed by practicing engineers with 15+ years experience
‚Ä¢ Based on real-world projects and challenges
‚Ä¢ Covers latest standards and best practices
‚Ä¢ Flexible online format fits busy schedules

**üîó Get Started:**
[Start Training Now ‚Üí](safety-training.html)
[Contact for Group Training ‚Üí](contact.html)

Which training module interests your team most?`;
        }

        // Quote/pricing responses
        if (lowerMessage.includes('quote') || lowerMessage.includes('price') || lowerMessage.includes('cost') || lowerMessage.includes('contact')) {
            return `**üí¨ Get Your Free Quote Today!**

R&C Ltd provides competitive quotes with detailed project breakdowns:

**üìû Multiple Ways to Connect:**
‚Ä¢ **Call Direct:** [+353 (0) 52 7443258](tel:+353527443258) - *Speak with an engineer*
‚Ä¢ **Email:** [info@rcltd.ie](mailto:info@rcltd.ie) - *Send project details*
‚Ä¢ **Online Form:** [Quick Quote Request ‚Üí](contact.html) - *24hr response*
‚Ä¢ **Site Visit:** Free consultation at your facility

**‚ö° Fast Quote Process:**
1. **Tell us your needs** - Service type, timeline, location
2. **We assess** - Our engineers review requirements
3. **You receive** - Detailed quote within 24-48 hours
4. **We deliver** - Professional implementation

**üíº For Best Quote, Include:**
‚Ä¢ Type of project (automation, safety, electrical, panels)
‚Ä¢ Timeline and budget range
‚Ä¢ Site location and access details
‚Ä¢ Existing equipment and standards
‚Ä¢ Any specific compliance requirements

**üèÜ Why Choose R&C Ltd:**
‚Ä¢ 15+ years experience
‚Ä¢ Competitive pricing
‚Ä¢ No hidden costs
‚Ä¢ Full project support

**üîó Get Started:**
[Request Quote Now ‚Üí](contact.html)

What type of project can we quote for you?`;
        }

        // Industry-specific responses
        if (lowerMessage.includes('pharmaceutical') || lowerMessage.includes('pharma') || lowerMessage.includes('gmp')) {
            return `**üíä Pharmaceutical Industry Expertise**

R&C Ltd specializes in pharmaceutical automation with deep GMP compliance knowledge:

**üè• Pharmaceutical Services:**
‚Ä¢ **GMP Compliant Systems** - 21 CFR Part 11, GAMP 5 guidelines
‚Ä¢ **Process Validation** - IQ/OQ/PQ documentation and execution
‚Ä¢ **Batch Control Systems** - Recipe management, electronic batch records
‚Ä¢ **Clean Room Automation** - Classified area equipment and controls
‚Ä¢ **Track & Trace Systems** - Serialization and traceability solutions
‚Ä¢ **Quality Control Automation** - Automated testing and inspection

**‚úÖ Compliance Standards:**
‚Ä¢ FDA 21 CFR Part 11 (Electronic Records)
‚Ä¢ EU GMP Guidelines
‚Ä¢ ISPE GAMP 5 (Good Automated Manufacturing Practice)
‚Ä¢ ISO 14971 (Risk Management)

**üî¨ Recent Pharma Projects:**
‚Ä¢ Tablet packaging line automation with batch tracking
‚Ä¢ Clean room HVAC control system with 21 CFR Part 11 compliance
‚Ä¢ API manufacturing process control system

**üîó Learn More:**
[Pharmaceutical Solutions ‚Üí](automation.html)
[Schedule GMP Consultation ‚Üí](contact.html)

What pharmaceutical process are you looking to automate?`;
        }

        if (lowerMessage.includes('automotive') || lowerMessage.includes('assembly') || lowerMessage.includes('manufacturing')) {
            return `**üöó Automotive Manufacturing Solutions**

R&C Ltd delivers robust automation for automotive production environments:

**‚öôÔ∏è Automotive Expertise:**
‚Ä¢ **Assembly Line Control** - Conveyor systems, station control, tracking
‚Ä¢ **Quality Control Systems** - Vision inspection, torque monitoring
‚Ä¢ **Robot Integration** - Welding, painting, material handling robots
‚Ä¢ **MES Integration** - Manufacturing Execution System connectivity
‚Ä¢ **Traceability Systems** - Part tracking, genealogy, quality data
‚Ä¢ **Lean Manufacturing** - Cycle time optimization, waste reduction

**üè≠ System Capabilities:**
‚Ä¢ High-speed production lines (up to 60 units/hour)
‚Ä¢ Multi-station synchronization
‚Ä¢ Flexible changeover for different models
‚Ä¢ Real-time production monitoring
‚Ä¢ Predictive maintenance systems

**üìä Proven Results:**
‚Ä¢ 15% increase in OEE (Overall Equipment Effectiveness)
‚Ä¢ 50% reduction in changeover time
‚Ä¢ Zero defect quality systems

**üîó Next Steps:**
[Automotive Case Studies ‚Üí](automation.html)
[Request Plant Visit ‚Üí](contact.html)

What automotive processes need automation in your facility?`;
        }

        if (lowerMessage.includes('food') || lowerMessage.includes('beverage') || lowerMessage.includes('haccp')) {
            return `**üçé Food & Beverage Industry Solutions**

R&C Ltd provides hygienic design automation for food and beverage production:

**ü•§ F&B Specializations:**
‚Ä¢ **Hygienic Design** - IP65/IP69K rated equipment, washdown systems
‚Ä¢ **HACCP Compliance** - Critical Control Point monitoring and control
‚Ä¢ **Batch Control** - Recipe management, ingredient tracking
‚Ä¢ **CIP/SIP Systems** - Cleaning-in-Place, Sterilization-in-Place automation
‚Ä¢ **Temperature Control** - Pasteurization, fermentation, cold chain
‚Ä¢ **Packaging Lines** - Filling, capping, labeling, case packing

**üõ°Ô∏è Food Safety Standards:**
‚Ä¢ HACCP (Hazard Analysis Critical Control Points)
‚Ä¢ BRC Global Standard
‚Ä¢ SQF (Safe Quality Food)
‚Ä¢ FDA Food Safety Modernization Act
‚Ä¢ EU Food Hygiene Regulations

**üèÜ F&B Project Examples:**
‚Ä¢ Dairy processing SCADA with CIP automation
‚Ä¢ Beverage filling line with track & trace
‚Ä¢ Bakery oven control with recipe management

**üîó Get Started:**
[Food Processing Solutions ‚Üí](automation.html)
[Food Safety Consultation ‚Üí](contact.html)

What food safety challenges can we help you solve?`;
        }

        // Location/company info
        if (lowerMessage.includes('location') || lowerMessage.includes('where') || lowerMessage.includes('address') || lowerMessage.includes('about') || lowerMessage.includes('company')) {
            return `**üè¢ About Robotics & Control Ltd**

**üìç Our Location:**
Unit 2 Cahir Business Park  
Cahir, Co. Tipperary  
Ireland, E21 C564

**üéØ Company Overview:**
‚Ä¢ **Founded:** 2010 (15+ years of excellence)
‚Ä¢ **Team:** Experienced engineers and technicians
‚Ä¢ **Scope:** Ireland and international projects
‚Ä¢ **Certifications:** Professional engineering memberships

**üèÜ Why Choose R&C Ltd:**
‚Ä¢ **Proven Track Record** - 200+ successful projects delivered
‚Ä¢ **Industry Expertise** - Pharmaceutical, automotive, food & beverage
‚Ä¢ **Full Service** - Design through commissioning and support
‚Ä¢ **Compliance Focus** - CE marking, safety standards, industry regulations
‚Ä¢ **Local Support** - Irish company with international reach

**ü§ù Professional Memberships:**
‚Ä¢ Engineers Ireland
‚Ä¢ Engineering the South East
‚Ä¢ T√úV Certified Engineers

**üìû Contact Us:**
[Call: +353 (0) 52 7443258](tel:+353527443258)
[Email: info@rcltd.ie](mailto:info@rcltd.ie)
[Visit Our Office ‚Üí](contact.html)

Would you like to schedule a site visit or consultation?`;
        }

        // Default helpful response with smart suggestions
        // Note: message is not directly included to prevent XSS via bot message reflection
        return `I understand your question. Let me help you find the right information!

**üîç Popular Topics:**
‚Ä¢ **[üîß Automation Services](automation.html)** - PLC, SCADA, robotics
‚Ä¢ **[üõ°Ô∏è Safety Solutions](safety.html)** - Risk assessment, compliance
‚Ä¢ **[‚ö° Electrical Design](design.html)** - Control systems, power distribution
‚Ä¢ **[üèóÔ∏è Panel Building](panel.html)** - Custom control panels, MCCs
‚Ä¢ **[üìö Safety Training](safety-training.html)** - Interactive online courses

**üè≠ Industry Solutions:**
‚Ä¢ **Pharmaceutical** - GMP compliance, process validation
‚Ä¢ **Automotive** - Assembly lines, quality control
‚Ä¢ **Food & Beverage** - Hygienic design, HACCP compliance

**üí¨ Quick Actions:**
[Get Free Quote ‚Üí](contact.html) | [Call Now: +353 (0) 52 7443258](tel:+353527443258)

Try the quick action buttons below or ask me about specific services, industries, or projects!`;
    }

    renderMessage(message) {
        const messagesContainer = document.getElementById('chatbot-messages');
        
        const messageElement = document.createElement('div');
        messageElement.className = `message ${message.type}-message`;
        
        const avatar = message.type === 'bot' ? 
            '<img src="images/logo.png" alt="Controller Bot" class="message-avatar">' : 
            '<div class="user-avatar">üë§</div>';
        
        const time = message.timestamp.toLocaleTimeString('en-US', { 
            hour: '2-digit', 
            minute: '2-digit' 
        });

        // Only apply formatting to bot messages for security
        const formattedContent = message.type === 'bot' ? 
            this.formatMessage(message.content) : 
            this.escapeHtml(message.content);

        // Create avatar element safely
        if (message.type === 'bot') {
            const avatarImg = document.createElement('img');
            avatarImg.src = 'images/logo.png';
            avatarImg.alt = 'Controller Bot';
            avatarImg.className = 'message-avatar';
            messageElement.appendChild(avatarImg);
        } else {
            const avatarDiv = document.createElement('div');
            avatarDiv.className = 'user-avatar';
            avatarDiv.textContent = 'üë§';
            messageElement.appendChild(avatarDiv);
        }

        // Create message content container
        const messageContentDiv = document.createElement('div');
        messageContentDiv.className = 'message-content';

        // Create message text element
        const messageTextDiv = document.createElement('div');
        messageTextDiv.className = 'message-text';
        
        // For bot messages, we can safely use innerHTML since content is controlled and pre-escaped
        // For user messages, use textContent to prevent any HTML
        if (message.type === 'bot') {
            messageTextDiv.innerHTML = formattedContent; // Safe: content is from controlled sources and pre-escaped
        } else {
            messageTextDiv.textContent = message.content; // Safe: direct text content
        }

        // Create timestamp element
        const timeDiv = document.createElement('div');
        timeDiv.className = 'message-time';
        timeDiv.textContent = time;

        // Assemble the structure
        messageContentDiv.appendChild(messageTextDiv);
        messageContentDiv.appendChild(timeDiv);
        messageElement.appendChild(messageContentDiv);

        messagesContainer.appendChild(messageElement);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    formatMessage(content) {
        // Convert markdown-like formatting to HTML with navigation links (bot messages only)
        // First escape any existing HTML to prevent injection
        return this.escapeHtml(content)
            .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
            .replace(/\*(.*?)\*/g, '<em>$1</em>')
            .replace(/\[([^\]]+)\]\(([^)]+)\)/g, (match, text, url) => {
                // Sanitize URLs - only allow safe schemes with proper full URL patterns
                if (url.match(/^(https?:\/\/[^\s"'<>]+|tel:[0-9+()\-\s]+|mailto:[^\s"'<>]+|[A-Za-z0-9._\/-]+\.html)$/)) {
                    // Text is already escaped above, URL is validated
                    return `<a href="${url}" target="_self" rel="noopener" class="chat-link">${text}</a>`;
                }
                return text; // Strip unsafe links, keep text
            })
            .replace(/‚Ä¢/g, '‚Ä¢');
            // Note: \n already converted to <br> by escapeHtml
    }

    escapeHtml(text) {
        // Escape HTML in user messages to prevent XSS
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML.replace(/\n/g, '<br>');
    }

    showTypingIndicator() {
        this.isTyping = true;
        const messagesContainer = document.getElementById('chatbot-messages');
        
        const typingElement = document.createElement('div');
        typingElement.className = 'message bot-message typing-indicator';
        typingElement.id = 'typing-indicator';
        
        typingElement.innerHTML = `
            <img src="images/logo.png" alt="Controller Bot" class="message-avatar">
            <div class="message-content">
                <div class="typing-dots">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
            </div>
        `;

        messagesContainer.appendChild(typingElement);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    hideTypingIndicator() {
        this.isTyping = false;
        const typingIndicator = document.getElementById('typing-indicator');
        if (typingIndicator) {
            typingIndicator.remove();
        }
    }
}

// Initialize Controller Bot when DOM is ready
document.addEventListener('DOMContentLoaded', () => {
    window.controllerBot = new ControllerBot();
});